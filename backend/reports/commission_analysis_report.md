# 報酬データ分析レポート

**実行日時**: 2025年10月1日
**分析対象**: Supabaseデータベース - commissionsテーブル
**条件**: `final_amount < 10000 AND status != 'carried_forward'`

## エグゼクティブサマリー

データベース分析により、**27件の問題のある報酬レコード**が発見されました。これらのレコードは最低支払額（¥10,000）を下回っているにも関わらず、繰り越し状態（`carried_forward`）に設定されていません。

### 主な発見事項

- **問題レコード数**: 27件（全体の42.9%）
- **影響範囲**: 6つの代理店
- **金額範囲**: ¥75 〜 ¥8,000
- **主な発生月**: 2025年9月（17件）

## 詳細分析結果

### 1. ステータス別分布

| ステータス | 件数 | 割合 |
|-----------|------|------|
| confirmed | 21件 | 77.8% |
| pending   | 6件  | 22.2% |

### 2. 月別発生状況

| 対象月 | 件数 | 主な特徴 |
|--------|------|----------|
| 2025-09 | 17件 | 最も多い発生月 |
| 2024-11 | 6件  | 過去データ |
| 2025-01 | 2件  | 年初データ |
| 2024-12 | 1件  | 年末データ |
| 2025-10 | 1件  | 最新データ |

### 3. 金額範囲別分析

| 金額範囲 | 件数 | 割合 | 特徴 |
|----------|------|------|------|
| ¥1-1,000 | 5件 | 18.5% | 極少額報酬 |
| ¥1,001-5,000 | 16件 | 59.3% | 最多ゾーン |
| ¥5,001-9,999 | 6件 | 22.2% | 中間ゾーン |

### 4. 影響を受けた代理店

| 代理店名 | 件数 | 代理店ID |
|----------|------|----------|
| 株式会社アルファ商事 | 10件 | a1111111-1111-1111-1111-111111111111 |
| 株式会社イプシロン | 9件 | a5555555-5555-5555-5555-555555555555 |
| dog | 3件 | 6e41059f-f1d5-418a-9a7c-7d00acc9cd5d |
| 株式会社ベータシステム | 3件 | a2222222-2222-2222-2222-222222222222 |
| イータソリューションズ | 1件 | a7777777-7777-7777-7777-777777777777 |
| 株式会社ゼータテック | 1件 | a6666666-6666-6666-6666-666666666666 |

## 問題の根本原因

### 1. 階層ボーナスレコードの処理不備

多くの問題レコードは**基本報酬が¥0で階層ボーナスのみ**のレコードです。これは以下の状況を示しています：

- 上位代理店が下位代理店の売上に対して受け取る階層ボーナス
- 売上を直接獲得していない代理店に対する間接的な報酬
- **例**: 売上¥150,000に対して基本報酬¥0、階層ボーナス¥2,250

### 2. インボイス控除の影響

インボイス未登録事業者に対する2%控除により、小額の基本報酬が更に減額されています：

- **例**: 売上¥15,000 → 基本報酬¥1,500 → インボイス控除¥30 → 最終報酬¥1,470

### 3. 最低支払額チェックロジックの不備

システムコードを確認すると、最低支払額チェック（¥10,000）は正しく実装されているにも関わらず、これらのレコードが`carried_forward`状態になっていません。

```javascript
// calculateCommission.js の Line 267-276
if (summary.total_amount < MIN_PAYMENT_AMOUNT) {
  commissions.forEach(commission => {
    if (commission.agency_id === agencyId) {
      commission.status = 'carried_forward';
      commission.carry_forward_reason = `最低支払額(¥${MIN_PAYMENT_AMOUNT.toLocaleString()})未満`;
    }
  });
}
```

### 4. データ整合性の問題

分析により以下のデータ整合性の問題が確認されました：

- **基本報酬計算の不整合**: 期待値と実際値の乖離
- **売上との紐付け**: 階層ボーナスレコードでの売上参照の複雑性

## 全体統計との比較

| 指標 | 件数 | 割合 |
|------|------|------|
| 総報酬レコード数 | 63件 | 100% |
| ¥10,000未満のレコード | 43件 | 68.3% |
| 正常な繰り越しレコード | 16件 | 25.4% |
| **問題のあるレコード** | **27件** | **42.9%** |

## 作成日時の傾向

最新の問題レコード（2025年10月1日）も含まれており、この問題は継続的に発生していることが確認されます。特に2025年9月に17件と集中しており、この時期に何らかのシステム変更や大量データ処理があった可能性があります。

## 推奨される対応策

### 即座の対応（緊急度：高）

1. **問題レコードの修正**
   ```sql
   UPDATE commissions
   SET status = 'carried_forward',
       carry_forward_reason = '最低支払額(¥10,000)未満'
   WHERE final_amount < 10000
   AND status != 'carried_forward';
   ```

### 中期的対応（緊急度：中）

2. **最低支払額チェックロジックの修正**
   - 代理店ごとの月次合計での判定強化
   - 階層ボーナスのみのレコードに対する特別処理

3. **データ整合性チェックの強化**
   - 報酬計算後の自動検証処理追加
   - 異常値検出アラート機能

### 長期的対応（緊急度：低）

4. **ビジネスルールの明確化**
   - 階層ボーナスのみのレコードの扱い
   - インボイス控除・源泉徴収の適用タイミング
   - 最低支払額基準の見直し

5. **システム改善**
   - 報酬計算プロセスのリファクタリング
   - テストケースの充実
   - 監視・アラート機能の追加

## 結論

分析により、システムの最低支払額チェック機能が一部のケースで正常に動作していないことが明確になりました。特に階層ボーナスのみのレコードや、インボイス控除により最終金額が減額されたレコードで問題が発生しています。

即座の修正により27件の問題レコードを解決し、システムロジックの見直しにより今後の発生を防止することを強く推奨します。

---
**レポート作成者**: システム分析スクリプト
**最終更新**: 2025年10月1日
**参照ファイル**: `/mnt/c/Users/RYU3/Desktop/agency-system-v2/backend/scripts/analyze_commission_data.js`